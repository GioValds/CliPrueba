name: Flutter CI/CD

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

env:
  FLUTTER_VERSION: '3.19.0'

jobs:
  analyze:
    name: Analyze Code
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        cache-key: flutter-${{ env.FLUTTER_VERSION }}
        
    - name: ğŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ğŸ” Analyze code
      run: dart analyze .
      
    - name: ğŸ¨ Check code format
      run: dart format --set-exit-if-changed . --output=none

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: analyze
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: ğŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ğŸ§ª Run unit tests
      run: flutter test test/calculator_test.dart test/api_client_test.dart --coverage
      
    - name: ğŸ¯ Run widget tests
      run: flutter test test/widget_test.dart --coverage
      
    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-flutter
        fail_ci_if_error: false

  build:
    name: Build App
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        
    - name: ğŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ğŸ”§ Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
        
    - name: ğŸ—ï¸ Build APK (Debug)
      run: flutter build apk --debug --target-platform android-arm,android-arm64
      
    - name: ğŸ—ï¸ Build AAB (Release)
      run: flutter build appbundle --target-platform android-arm,android-arm64
      
    - name: ğŸ“¤ Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: flutter-apk-debug
        path: build/app/outputs/flutter-apk/app-debug.apk
        retention-days: 7
        
    - name: ğŸ“¤ Upload AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: flutter-aab-release
        path: build/app/outputs/bundle/release/app-release.aab
        retention-days: 7

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        
    - name: ğŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ğŸ”§ Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ğŸ“± Setup Android Emulator
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 31
        target: google_apis
        arch: x86_64
        profile: Nexus 6
        disable-animations: true
        emulator-options: -no-window -gpu swiftshader_indirect -no-snapshot -noaudio -no-boot-anim
        script: |
          flutter devices
          flutter test integration_test/app_test.dart --dart-define=CI=true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: analyze
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        
    - name: ğŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ğŸ”’ Run security analysis
      run: |
        dart analyze --fatal-infos .
        echo "âœ… Security scan completed successfully"

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [analyze, test, build, integration-test, security-scan]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        
    - name: ğŸ“¦ Install dependencies
      run: flutter pub get
      
    - name: ğŸ“Š Generate test coverage
      run: |
        flutter test --coverage
        if command -v genhtml > /dev/null; then
          genhtml coverage/lcov.info -o coverage/html
          echo "ğŸ“ Coverage report generated at coverage/html/index.html"
        else
          echo "ğŸ“Š Raw coverage data available at coverage/lcov.info"
        fi
        
    - name: ğŸ‰ Quality Gate Passed
      run: |
        echo "âœ… All quality checks passed!"
        echo "ğŸ“ˆ Code Analysis: PASSED"
        echo "ğŸ§ª Unit Tests: PASSED" 
        echo "ğŸ¯ Widget Tests: PASSED"
        echo "ğŸ—ï¸ Build: PASSED"
        echo "ğŸ”’ Security: PASSED"
        echo "ğŸš€ Ready for deployment!"